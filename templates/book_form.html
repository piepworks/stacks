{% extends "base.html" %}

{% block title %}
    {% if action == 'new' %}
    Add a new book
    {% else %}
    Editing {{ book }}
    {% endif %}
{% endblock title %}

{% block body_tag %}class="form-page"{% endblock body_tag %}

{% block content %}
  <h1>
    {% if action == 'new' %}
    Add a new book
    {% else %}
    Editing <u>{{ book }}</u>
    {% endif %}
  </h1>

  {% if book.covers.all %}
    <section class="covers">
      {% for cover in book.covers.all %}
        <div>
          <img width="200"
              height="auto"
              alt="{{ cover }}"
              src="{{ cover.image.url }}">
          <div class="actions">
            <a href="{% url 'cover_update' book.id cover.id %}" class="svg edit">Edit</a>
            <form action="{% url 'cover_delete' book.id cover.id %}" method="post" onsubmit="return confirm('Are you sure you want to delete this cover?')">
              {% csrf_token %}
              <button class="svg delete">Delete</button>
            </form>
          </div>
        </div>
      {% endfor %}
      {% if action == 'update' %}
        <div class="no-cover another">
          {# https://remixicon.com/icon/book-line #}
          <svg class="book" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18.5V5C3 3.34315 4.34315 2 6 2H20C20.5523 2 21 2.44772 21 3V21C21 21.5523 20.5523 22 20 22H6.5C4.567 22 3 20.433 3 18.5ZM19 20V17H6.5C5.67157 17 5 17.6716 5 18.5C5 19.3284 5.67157 20 6.5 20H19ZM5 15.3368C5.45463 15.1208 5.9632 15 6.5 15H19V4H6C5.44772 4 5 4.44772 5 5V15.3368Z"></path></svg>
          <p>Add a cover</p>
          <a class="svg add-cover" href="{% url 'cover_new' book.id %}">Add cover</a>
        </div>
      {% endif %}
    </section>
  {% else %}
    {% if action == 'update' %}
      <div class="no-cover">
        {# https://remixicon.com/icon/book-line #}
        <svg class="book" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18.5V5C3 3.34315 4.34315 2 6 2H20C20.5523 2 21 2.44772 21 3V21C21 21.5523 20.5523 22 20 22H6.5C4.567 22 3 20.433 3 18.5ZM19 20V17H6.5C5.67157 17 5 17.6716 5 18.5C5 19.3284 5.67157 20 6.5 20H19ZM5 15.3368C5.45463 15.1208 5.9632 15 6.5 15H19V4H6C5.44772 4 5 4.44772 5 5V15.3368Z"></path></svg>
        <p>No cover found for this book.</p>
        <a class="svg add-cover" href="{% url 'cover_new' book.id %}">Add cover</a>
      </div>
    {% endif %}
  {% endif %}

  <form method="post">
    {% csrf_token %}
    <fieldset>
      {% for field in form %}
        <div{% if field.name == "on_hand" %} class="checkbox"{% endif %}>
          {{ field.errors }}
          {% if field.name == "on_hand" %}
            <label>
              {{ field }}
              {{ field.label }}
            </label>
          {% else %}
            <label>
              {{ field.label }}
              {% if field.name == 'author' %}
                <a href="{% url 'admin:core_author_add' %}" onclick="event.preventDefault(); document.querySelector('#author-new').showModal(); document.querySelector('#new-author-name').focus();">add another</a>
              {% endif %}
              {{ field }}
            </label>
          {% endif %}
        </div>
      {% endfor %}

      <input type="submit" value="Save">
    </fieldset>
  </form>
  {% include "components/author-new.html" %}
{% endblock content %}

{% block page_js %}
<script>
  new TomSelect('#id_author', {
    onItemAdd: function(author_id) {
      // Append the author to the querystring
      // so that the new author is added to the list
      // in the format `&author=1&author=2`
      var url = new URL(window.location.href);
      url.searchParams.append('new_author', author_id);
      // Apply the querystring without (reloading the page and?)
      // making scroll position jump
      var stateObj = { url: url.search };
      history.replaceState(stateObj, "", url.search);
    },
  });
</script>
{% endblock page_js %}
