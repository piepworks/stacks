{% extends "base.html" %}

{% block title %}
    {% if action == 'new' %}
    Add a new book
    {% else %}
    Editing {{ book }}
    {% endif %}
{% endblock title %}

{% block body_tag %}class="form-page"{% endblock body_tag %}

{% block content %}
  <h1>
    {% if action == 'new' %}
    Add a new book
    {% else %}
    Editing <u>{{ book }}</u>
    {% endif %}
  </h1>

  {% if book.covers.all %}
    <section class="covers">
      {% for cover in book.covers.all %}
        <div>
          <img width="200"
              height="auto"
              alt="{{ cover }}"
              src="{{ cover.image.url }}">
          <div class="actions">
            <a href="{% url 'cover_update' book.id cover.id %}" class="svg edit">Edit</a>
            <form action="{% url 'cover_delete' book.id cover.id %}" method="post" onsubmit="return confirm('Are you sure you want to delete this cover?')">
              {% csrf_token %}
              <button class="svg delete">Delete</button>
            </form>
          </div>
        </div>
      {% endfor %}
      {% if action == 'update' %}
        <div class="another">
          <a class="svg add-item" href="{% url 'cover_new' book.id %}">Add cover</a>
        </div>
      {% endif %}
    </section>
  {% else %}
    {% if action == 'update' %}
      <div class="no-cover">
        {# https://remixicon.com/icon/book-line #}
        <svg class="book" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18.5V5C3 3.34315 4.34315 2 6 2H20C20.5523 2 21 2.44772 21 3V21C21 21.5523 20.5523 22 20 22H6.5C4.567 22 3 20.433 3 18.5ZM19 20V17H6.5C5.67157 17 5 17.6716 5 18.5C5 19.3284 5.67157 20 6.5 20H19ZM5 15.3368C5.45463 15.1208 5.9632 15 6.5 15H19V4H6C5.44772 4 5 4.44772 5 5V15.3368Z"></path></svg>
        <p>No cover found for this book.</p>
        <a class="svg add-item" href="{% url 'cover_new' book.id %}">Add cover</a>
      </div>
    {% endif %}
  {% endif %}

  {# TODO: Attempt fetching the appropriate cover image from https://openlibrary.org/ #}

  <form method="post">
    {% csrf_token %}
    <fieldset>
      {% for field in form %}
        <div{% if field.name == "on_hand" %} class="checkbox"{% endif %}>
          {{ field.errors }}
          {% if field.name == "on_hand" %}
            <label>
              {{ field }}
              {{ field.label }}
            </label>
          {% else %}
            <label>
              {{ field.label }}
              {{ field }}
            </label>
          {% endif %}
        </div>
      {% endfor %}

      <input type="submit" value="Save">
    </fieldset>
  </form>
  {% include "components/author-new.html" %}
{% endblock content %}

{% block page_js %}
<script>
  new TomSelect('#id_author', {
    create: function(input, callback) {
      // Get CSRF token
      const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken')).split('=')[1];

      // Gather necessary data
      const authorData = {
        name: input, // assuming the input is the author's name
        // add other necessary data
      };

      // Send POST request
      fetch("{% url 'author_new' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify(authorData),
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {
          // Call the callback function with the new option
          callback({
            value: data.id,
            text: input
          });
        })
        .catch((error) => {
          console.error('There has been a problem with your fetch operation:', error);
        });
    },
    createOnBlur: true,
  });
</script>
{% endblock page_js %}
