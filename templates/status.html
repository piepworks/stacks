{% extends "base.html" %}
{% load get_next_status get_previous_status %}

{% block body_tag %}
  class="status"
{% endblock body_tag %}

{% block title %}
  {{ status.name }}
{% endblock title %}

{% block header %}
  {% include "components/status-nav.html" %}
{% endblock header %}

{% block content %}
  <header class="actions-inline">
    <h1>{{ status.name }}</h1>
    <a class="svg add-item" href="{% url 'book_new' %}?status={{ status.slug }}" onclick="event.preventDefault(); document.querySelector('#add-book').showModal();document.querySelector('#add-book input[name=q]').focus()">add another</a>
  </header>

  {% if finished_counts %}
    <dl class="finished-counts">
      {% for count in finished_counts reversed %}
        <div>
          <dt>{{ count.readings__end_date__year }}</dt>
          <dd>
            {{ count.count }}
          </dd>
        </div>
      {% endfor %}
    </dl>
  {% endif %}

  <div x-data="bookList">
    {% if status.slug != 'wishlist' %}
      {% comment %}
      <section class="filters" x-show="formatsVisible">
        <div>
          <input type="radio" id="all" name="format" value="all" x-model="formatSelected">
          <label for="all">All <small>(<span x-text="document.querySelectorAll('[data-formats]').length"></span>)</small></label>
        </div>
        {% for format in formats %}
          <div class="format-field" x-show="document.querySelectorAll('[data-formats*={{ format.slug }}]').length">
            <input type="radio" id="{{ format.slug }}" name="format" value="{{ format.slug }}" x-model="formatSelected">
            <label for="{{ format.slug }}">{{ format.name }} <small>(<span x-text="document.querySelectorAll('[data-formats*={{ format.slug }}]').length"></span>)</small></label>
          </div>
        {% endfor %}
      </section>
      {% endcomment %}
    {% endif %}

    <ul>
      <template x-for="book in filteredBooks" :key="book.id">
        <li class="book">
          <a :href="book.url">
            <template x-if="book.cover">
              <img :src="book.cover"
                  alt="{{ cover }}"
                  width="150"
                  height="auto"
                  title="book.title">
            </template>
            <template x-if="!book.cover">
              <div class="no-cover">
                {# https://remixicon.com/icon/book-line #}
                <svg class="book" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18.5V5C3 3.34315 4.34315 2 6 2H20C20.5523 2 21 2.44772 21 3V21C21 21.5523 20.5523 22 20 22H6.5C4.567 22 3 20.433 3 18.5ZM19 20V17H6.5C5.67157 17 5 17.6716 5 18.5C5 19.3284 5.67157 20 6.5 20H19ZM5 15.3368C5.45463 15.1208 5.9632 15 6.5 15H19V4H6C5.44772 4 5 4.44772 5 5V15.3368Z"></path></svg>
              </div>
            </template>
          </a>
          <div class="title" :title="book.title" x-text="book.title"></div>
          <div class="actions">
            <template x-if="book.previous_status">
              <form :action="book.update_url" method="post">
                {% csrf_token %}
                <input type="hidden" name="status_change" value="true">
                <input type="hidden" name="status" :value="book.previous_status">
                <div x-html="book.form"></div>
                <button class="svg previous-status">Previous status</button>
              </form>
            </template>
            <template x-if="!book.previous_status"><span>&nbsp;</span></template>
            <button class="svg adjust-status" @click="openModal = book.id">
              Adjust status
            </button>
            <template x-if="book.next_status">
              <form :action="book.update_url" method="post">
                {% csrf_token %}
                <input type="hidden" name="status" :value="book.next_status">
                <input type="hidden" name="status_change" value="true">
                <div x-html="book.form"></div>
                <button class="svg next-status">Next status</button>
              </form>
            </template>
            <template x-if="!book.next_status"><span>&nbsp;</span></template>
          </div>
          {% include "components/status-modal.html" %}
        </li>
      </template>
    </ul>
  </div>

  <hr>

  {% include "components/search-form.html" %}

  <dialog id="add-book">
    <article>
      <header>
        <button aria-label="Close"
                rel="prev"
                onclick="document.querySelector('#add-book').close()"></button>
        <p><b>Search to add a book to “{{ status.name }}”</b></p>
        <p>or <a href="{% url 'book_new' %}?status={{ status.slug }}">add manually</a></p>
      </header>
      <form method="get" action="{% url 'open_library_search' %}">
        <fieldset>
          <input type="hidden" name="status" value="{{ status.slug }}">
          <input type="text" name="q" required>
        </fieldset>
        <button type="submit">Search Open Library</button>
      </form>
    </article>
  </dialog>
{% endblock content %}

{% block page_js %}
<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('bookList', () => ({
      openModal: null,
      books: [
        {% for book, form in forms %}
          {
            form: `{{ form }}`,
            id: "{{ book.id }}",
            title: "{{ book }}",
            status: "{{ book.status }}",
            previous_status: "{{ book.status|get_previous_status|default_if_none:'null' }}",
            next_status: "{{ book.status|get_next_status|default_if_none:'null' }}",
            url: "{% url 'book_detail' book.slug %}",
            update_url: "{% url 'book_update' book.slug %}",
            archive_url: "{% url 'book_archive' book.slug %}",
            formats: [{% for format in book.format.all %}{ id: {{ format.id }}, slug: "{{ format.slug }}" }{% if not forloop.last %},{% endif %}{% endfor %}],
            locations: [{% for location in book.location.all %}{ id: {{ location.id }}, slug: "{{ location.slug }}" }{% if not forloop.last %},{% endif %}{% endfor %}],
            type: "{{ book.type.slug }}",
            genre: "{{ book.genre.slug }}",
            {% if book.covers.all %}
              {% with book.covers.all|first as cover %}
                cover: "{{ cover.thumbnail.url }}",
              {% endwith %}
            {% else %}
              cover: null,
            {% endif %}
          }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ],
      filters: {
				type: 'all',
				location: 'all',
				format: 'all',
        genre: 'all',
			},
      get filteredBooks() {
				return this.books.filter(book => {
					const formatMatch = this.filters.format === 'all' || book.formats.some(format => format.slug === this.filters.format);
					const locationMatch = this.filters.location === 'all' || book.locations.some(location => location.slug === this.filters.location);
					const typeMatch = this.filters.type === 'all' || book.type === this.filters.type;
          const genreMatch = this.filters.genre === 'all' || book.genre === this.filters.genre;
					return formatMatch && locationMatch && typeMatch && genreMatch;
				});
			},
      get filterCount() {
				return (filterType, filterValue) => {
					switch (filterType) {
						case 'type':
							return filterValue === 'all' ? this.books.length : this.books.filter(book => book.type === filterValue).length;
						case 'location':
							return filterValue === 'all' ? this.books.length : this.books.filter(book => book.locations.some(location => location.slug === filterValue)).length;
						case 'format':
							return filterValue === 'all' ? this.books.length : this.books.filter(book => book.formats.some(format => format.slug === filterValue)).length;
						default:
							return this.books.length;
					}
				};
			},
    }));
  });
</script>
{% endblock page_js %}
