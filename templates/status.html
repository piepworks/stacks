{% extends "base.html" %}
{% load get_next_status get_previous_status get_item %}

{% block body_tag %}
  class="status"
{% endblock body_tag %}

{% block title %}
  {{ status.name }}
{% endblock title %}

{% block header %}
  {% include "components/status-nav.html" %}
{% endblock header %}

{% block content %}
  <div x-data="bookList">
    <header class="actions-inline">
      <div>
        <h1>{{ status.name }}</h1>
        <a class="svg add-item" href="{% url 'book_new' %}?status={{ status.slug }}" @click.prevent="openNewBookModal = true">add another</a>
      </div>
      <div class="filter-toggle">
        <p x-cloak x-show="filteredBooks.length !== books.length">
          <a href="{{ request.path }}" @click.prevent="resetFilters">Showing <span x-text="filteredBooks.length"></span> of <span x-text="books.length"></span> books</a>
        </p>
        <button class="svg no-filter" disabled x-ignore>Show filters</button>
        <button class="svg" :class="{'filter': openFilters, 'no-filter': !openFilters}" @click="openFilters = !openFilters" x-cloak>Show filters</button>
      </div>
    </header>

    {% if finished_counts %}
      <dl class="finished-counts">
        {% for count in finished_counts reversed %}
          <div>
            <dt>{{ count.readings__end_date__year }}</dt>
            <dd>
              {{ count.count }}
            </dd>
          </div>
        {% endfor %}
      </dl>
    {% endif %}

    <dl id="ajax-filters" class="filters">
      <div>
        <dt>Types</dt>
        <dd>
          <div>
            <label>
              <input type="radio" name="type" value="all" {% if not type_filter %}checked{% endif %}>
              All
            </label>
          </div>
          <div>
            <label>
              <input type="radio" name="type" value="textual" {% if type_filter == 'textual' %}checked{% endif %}>
              Textual
            </label>
          </div>
          <div>
            <label>
              <input type="radio" name="type" value="visual" {% if type_filter == 'visual' %}checked{% endif %}>
              Visual
            </label>
            <div class="sub-filters">
              <label>
                <input type="radio" name="type" value="comic" {% if type_filter == 'comic' %}checked{% endif %}>
                Comics
              </label>
              <label>
                <input type="radio" name="type" value="photo" {% if type_filter == 'photo' %}checked{% endif %}>
                Photo Books
              </label>
              <label>
                <input type="radio" name="type" value="picture" {% if type_filter == 'picture' %}checked{% endif %}>
                Picture Books
              </label>
            </div>
          </div>
        </dd>
      </div>
      <div>
        <dt>Genres</dt>
        <dd>
          <div>
            <label>
              <input type="radio" name="genre" value="all" {% if not genre_filter %}checked{% endif %}>
              All
            </label>
          </div>
          {% for genre in genres %}
            {% if not genre.parent %}
              <div>
                <label>
                  <input type="radio" name="genre" value="{{ genre.slug }}" {% if genre.slug == genre_filter %}checked{% endif %}>
                  {{ genre.name }}
                </label>
                {% if has_sub_genres|get_item:genre.slug %}
                  <div class="sub-filters">
                    {% for sub_genre in genres %}
                      {% if sub_genre.parent == genre %}
                        <label>
                          <input type="radio" name="genre" value="{{ sub_genre.slug }}" {% if sub_genre.slug == genre_filter %}checked{% endif %}>
                          {{ sub_genre.name }}
                        </label>
                      {% endif %}
                    {% endfor %}
                  </div>{# / Sub genre #}
                {% endif %}
              </div>{# / Parent genre #}
            {% endif %}
          {% endfor %}
        </dd>
      </div>
      {% if status.slug != 'wishlist' %}
        <div>
          <dt>Formats</dt>
          <dd>
            <div>
              <label>
                <input type="radio" name="format" value="all" {% if not format_filters %}checked{% endif %}>
                All
              </label>
            </div>
            {% for format in formats %}
              {% if format_filters|get_item:format.slug %}
                <div>
                  <label>
                    <input type="radio" name="format" value="{{ format.slug }}" {% if format.slug in format_filters %}checked{% endif %}>
                    {{ format.name }}
                  </label>
                </div>
              {% endif %}
            {% endfor %}
          </dd>
        </div>
        <div>
          <dt>Locations</dt>
          <dd>
            <div>
              <label>
                <input type="radio" name="location" value="all" {% if not location_filters %}checked{% endif %}>
                All
              </label>
            </div>
            {% for location in locations %}
              {% if location_filters|get_item:location.slug %}
                <div>
                  <label>
                    <input type="radio" name="location" value="{{ location.slug }}" {% if location.slug in location_filters %}checked{% endif %}>
                    {{ location.name }}
                  </label>
                </div>
              {% endif %}
            {% endfor %}
          </dd>
        </div>
      {% endif %}
    </dl>

    <ul id="ajax-books">
      {% for book, form in forms %}
        <li>
          <a href="{% url 'book_detail' book.slug %}">
            {% if book.covers.all %}
              {% with book.covers.all|first as cover %}
                <img src="{{ cover.thumbnail.url }}"
                    alt="{{ cover }}"
                    width="150"
                    height="auto"
                    title="{{ book }}">
              {% endwith %}
            {% else %}
              <div class="no-cover">
                {# https://remixicon.com/icon/book-line #}
                <svg class="book" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18.5V5C3 3.34315 4.34315 2 6 2H20C20.5523 2 21 2.44772 21 3V21C21 21.5523 20.5523 22 20 22H6.5C4.567 22 3 20.433 3 18.5ZM19 20V17H6.5C5.67157 17 5 17.6716 5 18.5C5 19.3284 5.67157 20 6.5 20H19ZM5 15.3368C5.45463 15.1208 5.9632 15 6.5 15H19V4H6C5.44772 4 5 4.44772 5 5V15.3368Z"></path></svg>
              </div>
            {% endif %}
          </a>
          <div class="title" title="{{ book }}">{{ book }}</div>
          <div class="actions">
            {% if book.status|get_previous_status != None %}
              <form action="{% url 'book_update' book.slug %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="status_change" value="true">
                <input type="hidden" name="status" value="{{ book.status|get_previous_status }}">
                {{ form }}
                <button class="svg previous-status">Previous status</button>
              </form>
            {% else %}
              <span class="empty left"></span>
            {% endif %}
            <button disabled class="svg adjust-status">
              Adjust status
            </button>
            {% if book.status|get_next_status != None %}
              <form action="{% url 'book_update' book.slug %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="status" value="{{ book.status|get_next_status }}">
                <input type="hidden" name="status_change" value="true">
                {{ form }}
                <button class="svg next-status">Next status</button>
              </form>
            {% else %}
                <span class="empty right"></span>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>

    <div id="ajax-pagination">
      {% if page_obj.has_previous %}
      <form x-init x-target.replace="ajax-books ajax-filters ajax-pagination" x-merge="update" method="post" action="{% url 'status' status.slug %}?page={{ page_obj.previous_page_number }}">
        {% csrf_token %}
        <button>
          Previous
        </button>
      </form>
      {% else %}
      <button disabled>Previous</button>
      {% endif %}

      <p>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</p>

      {% if page_obj.has_next %}
      <form x-init x-target.replace="ajax-books ajax-filters ajax-pagination" x-merge="update" method="post" action="{% url 'status' status.slug %}?page={{ page_obj.next_page_number }}">
        {% csrf_token %}
        <button>
          Next
        </button>
      </form>
      {% else %}
      <button disabled>Next</button>
      {% endif %}
    </div>

    {% include "components/add-book-modal.html" %}
  </div>

  <hr>

  {% include "components/search-form.html" %}

{% endblock content %}

{% block page_js %}
<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('bookList', () => ({
      openStatusModal: null,
      openNewBookModal: false,
      openFilters: false,
      init() {
        document.documentElement.classList.add('alpine');
      }
    }));
  });
</script>
{% endblock page_js %}
